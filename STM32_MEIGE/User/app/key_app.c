/*
*********************************************************************************************************
* Copyright     :
* Filename      : KEY_app.c
* Description   :
* Author        :
* Version       : V1.0
* Date          : 2021-12-01
* History       :
*********************************************************************************************************
* Note(s)       :
*
*********************************************************************************************************
*/

/*
*********************************************************************************************************
*                                           INCLUDE FILES
*********************************************************************************************************
*/
#define APP_KEY_MODULE

#include "includes.h"
#include "bsp_key.h"

/*
*********************************************************************************************************
*                                           LOCAL DEFINES
*********************************************************************************************************
*/
TX_EVENT_FLAGS_GROUP                        key_event_flag;

/*
*********************************************************************************************************
*                                        LOCAL GLOBAL VARIABLES
*********************************************************************************************************
*/

/*
*********************************************************************************************************
*                                          GLOBAL VARIABLES
*********************************************************************************************************
*/

extern void BSP_KEY_Init(void);
extern void USB_VbusFS(uint8_t state);
/*
*********************************************************************************************************
*                                             PROTOTYPES
*********************************************************************************************************
*/ 

/*
*********************************************************************************************************
*                                             Task_KEY()
*
* Description : The KEY Task.
*
* Argument(s) : none
*
* Return(s)   : none
*
* Caller(s)   : none.
*
* Note(s)     : none.
*********************************************************************************************************
*/
#if USE_THREADX
void Task_KEY(ULONG thread_input)
{
    static      ULONG status = 0;
    ULONG       recv_flag = 0;

    BSP_KEY_Init();

    /* Create the event flags group */
    if (tx_event_flags_create(&key_event_flag, "key event falg") != TX_SUCCESS)
    {
        LOG_E("tx_event_flags_create failed\r\n");
        return;
    }

    LOG_I("start...\r\n");
    while (1)
    {

        ULONG sta = tx_event_flags_get(&key_event_flag, 0x01, TX_OR_CLEAR,
                                               &recv_flag, TX_WAIT_FOREVER);
        {
            //HardFault here...
            //USB_VbusFS((status++) % 2);
        }

        tx_thread_sleep(MS_TO_TICK(1000));
    }
}
#endif
